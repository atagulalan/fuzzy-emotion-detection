<!DOCTYPE html>
<html>
<head>
  <script src="js/face-api.js"></script>
  <script src="js/functions.js"></script>
  <script src="js/main.js"></script>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="hider">
    <div id="fitter">
      <div id="wrapper">
        <video onloadedmetadata="onPlay(this)" id="inputVideo" autoplay muted playsinline></video>
        <canvas id="overlay" />
      </div>
    </div>
  </div>
</body>

  <script>
    let withBoxes = false
    const videoEl = document.getElementById('inputVideo')
    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 })
    const canvas = document.getElementById('overlay')

    async function onPlay() {
      if(videoEl.paused || videoEl.ended || !(!!faceapi.nets.tinyFaceDetector.params))
        return setTimeout(() => onPlay())

      const result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks()

      if (result) {

        const dims = faceapi.matchDimensions(canvas, videoEl, true)
        const resizedResult = faceapi.resizeResults(result, dims)

        if (withBoxes) {
          faceapi.draw.drawDetections(canvas, resizedResult)
        }
        faceapi.draw.drawFaceLandmarks(canvas, resizedResult)

        draw(result, dims)
        
      }

      setTimeout(() => onPlay())
    }

    async function run() {
      // load face detection and face landmark models
      await faceapi.loadFaceLandmarkModel('/weights/')

      // try to access users webcam and stream the images
      // to the video element
      const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
      const videoEl = document.getElementById('inputVideo')
      videoEl.srcObject = stream
    }

    async function initFaceDetectionControls() {
      await faceapi.nets.tinyFaceDetector.load('/weights/')
    }

    function ready(fn) {
      if (document.readyState != 'loading'){
        fn()
      } else {
        document.addEventListener('DOMContentLoaded', fn);
      }
    }

    ready(()=>{
      initFaceDetectionControls()
      run()
    })
  </script>
</body>
</html>